# Intro

This is a demo of Percepio DevAlert on the Cypress PSoC 64, using the PSoC® 64 Secure AWS IoT Pioneer Kit. The demo is based on the Cypress/AWS demo 
provided with this kit. Only small changes have been made to include the DevAlert Firmware Monitor and a suitable demo.

To try all parts of DevAlert, including the cloud service, you will need:

1. An AWS account

2. An evaluation package for Percepio DevAlert (provided on request). 

3. A development board running FreeRTOS and with connectity to AWS IoT Core 

Apply for the DevAlert evaluation package at https://percepio.com/devalert/. Once approved, we will grant you access to the DevAlert cloud service and send additional instructions regarding the cloud-side setup. Note that applications are reviewed and processed manually, so it might take a few hours or perhaps a working day for us to respond, depending on your time zone.
 
## Quick start

This demo is intended for the Cypress PSoC® 64 Secure AWS IoT Pioneer Kit. However, DevAlert can easily be added to any firmware project based on FreeRTOS, assuming you have AWS IoT Core connectivity via MQTT.

The PSoC 64 demo project is built and configured in the same way as for the original Cypress/AWS demo. We have only made small changes to include the DevAlert Firmware Monitor and suitable demo alerts.

Begin by follow the instruction at https://docs.aws.amazon.com/freertos/latest/userguide/getting_started_cypress_psoc64.html, but using this project instead of the original Cypress/AWS project. The demo should thereafter be ready to run.

Make sure you have a serial terminal program connected to the right COM port. For Windows users, Teraterm is recommended.
 
When the board is programmed and connected to a serial terminal, the text "iot_thread Press BTN0 or swipe left to generate Alerts." should appear after a while. Note that the boot process takes about 30 seconds, including getting an IP address and connecting to AWS. After that, the CapSense buttons and slider can be used to generate alerts to DevAlert that will show up in Tracealyzer. 

To see how to configure Tracealyzer go to: https://percepio.com/evaluate-devalert-cypress-cy8ckit-064/
 
# Percepio DevAlert

Percepio DevAlert is a solution for alerting developers about errors (or other issues) in their deployed IoT devices, e.g. during field testing or customer operation. The Alerts include a software trace and thereby provides excellent means for remote diagnostics of the reported issues.

DevAlert only uploads data when an Alert is generated by the device software, by calling the DevAlert API. Alerts are uploaded using the existing IoT connection, in the same way as regular application data. DevAlert is not using the connectivity in any other way.

All alerts are processed and stored in the cloud in order to group individual alerts into unique issues. Whenever a new issue is found, notifications are sent to the provided email addresses. All issues and alerts can also be viewed in the DevAlert Dashboard, found in the Tracealyzer application. A web-based dashboard is under development and should be available during Q4 2020. 

The cloud-side part of DevAlert is divided into two domains (AWS accounts). The regular AWS account used by the device (the "customer account") is responsible for device-to-cloud connectivity and for storing the uploaded Alerts. A CloudFormation script is provided that automates the necessary AWS setup. This also sets up the connection to the second part of DevAlert, the DevAlert cloud service, which is hosted by Percepio. This needs certain information about each Alert to allow for classification and relevant notifications. This also minimizes the amount of processing needed in the customer account. The data transfer is completely transparent and it includes no sensitive information, only things like the device name, firmware version, and numerical codes like "alert type" (e.g. "out of memory"). As mentioned, the Alerta also includes a trace of recent software events but this is not needed by the DevAlert cloud service and remains on the customer side at all times.

## DevAlert Firmware Monitor (DFM)

The device side of DevAlert is called the DevAlert Firmware Monitor (DFM). DFM is provided in C source code and provides an API for generating Alerts. DFM has one major subcomponent, the TraceRecorder library, which stores software events from the kernel and application logging to a ring-buffer in RAM. 
When an Alert is generated, you may either upload the Alert data to the cloud directly, or store the Alert data to non volatile memory (e.g. MCU flash) if the system needs to be restarted before an upload is possible (e.g. in case of hard faults). DFM will then upload the Alert automatically when it is initialized again after the restart.
 
DFM Library file structure:

 - percepio_dfm.c/h: The public API for initializing DFM and generating Alerts.
 - percepio_dfmConfig.h: Configuration options for the DFM Library.
 - dfmKernelPort.c/h: The interface towards the kernel. This can be modified to fit another RTOS kernel.
 - dfmCloudPort.c/h: Defines how to upload data to the cloud.
 - dfmCloudPortConfig.h: Configuration options for the cloud port.
 - dfmHardwarePort.c/h: Defines how to store data in non-volatile memory. This can be replaced to work with other MCUs or storage methods.
 - dfmCodes.h: Defines the Alert codes and Symptom codes. This file should be generated from the DevAlert cloud service.
 
You need to be aware of three central DevAlert concepts:
- Alert type: describes the overall type, for instance "Out of memory", "Assert failed", "Stack overflow" etc. 
- Sympotoms: additional details about an alert, e.g. the location in the program code from the __FILE__ and __LINE__ macros.
- Issue: all alerts with the same alert type and symptom values.

You can define your own alert types and symptoms to match your needs, but you should not edit dfmCodes.h directly. The DevAlert cloud service needs to be aware of your definitions to show the Dashboard correctly, so it provides a form for defining your alert types and symptoms, and from there you then generate a new dfmCodes.h file. Note that the numeric codes are assigned automatically and are specific for each customer, which provides additional security.

To generate an Alert, call ulDfmAlert() with the alert type as parameter. Then add any additional symptoms using ulDfmAddSymptom(). Finally call ulDfmSendDataToCloud() or ulDfmSaveDataToNonVolatileMemory(). Detailed information is provided below.

## TraceRecorder library
The DevAlert Firmware Monitor includes the Percepio TraceRecorder library in order to provide software traces with the alerts. The trace data may include both RTOS kernel events (e.g. scheduling events and API calls) and custom "user events" logged by the application code. 
The trace data is in a compact binary data format intended for Percepio Tracealyzer, that provides visual trace diagnostics. This is very useful for debugging and for general analysis of the runtime behavior. The traces provides important context about the Alert - what was going on in the software when the problem was detected? The trace may reveal the problem directly, or at least help you replicate the problem in the lab. Note that you may add user events in the application to get additional information, for instance logging inputs and important state changes. 

The TraceRecorder library has been refined since 2009 and is trusted by hundreds of development teams world wide. It is designed to be highly memory efficient.

For DevAlert, the recorder should be configured for snapshot mode, where trace data is kept in a RAM ring buffer. To integrate the recorder library, follow the getting started guide for FreeRTOS [here](https://percepio.com/gettingstarted-freertos/). 

You can verify that the snapshot trace recording works as intended by using our [Eclipse plugin](https://marketplace.eclipse.org/content/percepio-trace-exporter). It is compatible with ModusToolbox.

## Tracealyzer
Tracealyzer is the desktop application that is used to visualize and analyze trace data collected from the device. For more information about Tracealyzer see [here](https://percepio.com/tracealyzer/). From version 4.4.0 this also includes DevAlert support, most notably a DevAlert Dashboard on the welcome page. Note that you need a special license to enable the DevAlert integration. To get it, apply for a DevAlert evaluation license. 

As of September 2020, DevAlert has been tested with FreeRTOS and ThreadX. It should also work with SafeRTOS, Micrium µC/OS-III and VxWorks with only minor adjustments, but this has not yet been verified. These and other forms of RTOS support can be provided on request.

# Example
Follow these steps to integrate DevAlert into an existing project. This assumes you are using FreeRTOS and AWS IoT Core.

- Integrate the TraceRecorder as described in this [quick start guide](https://percepio.com/gettingstarted-freertos/). More information is also found in the Tracealyzer user manual.
- Verify that the TraceRecorder works as intended in snapshot mode, e.g. using the [Eclipse plugin](https://marketplace.eclipse.org/content/percepio-trace-exporter). You may need to review trcConfig.h, trcSnapshotConfig.h and update FreeRTOSConfig.h.
- Add the DFM library to your build.
- Modify percepio_dfmConfig.h and dfmCloudPortConfig.h to fit your setup.
- Call ulDfmInit(..) right after the application has connected to the cloud.
- Add calls to generate Alerts at suitable locations, e.g. in existing error handlers. Se below for an example. Details are found in percepio_dfm.h.
- Add #include "percepio_dfm.h" in all .c files that use the DFM library. 

Below is an example showing how to generate an alert in case of a failed malloc call (out of heap memory).
```
/* Error handler - Failed to allocate requested memory */
void vApplicationMallocFailedHook()
{
	// Adding a "user event" to the trace buffer
	vTracePrintF(devalert_user_event_channel, "Malloc failed.\r\n");

	// Pause tracing during upload
	vTraceStop();

	// Compose the Alert
	ulDfmAlert( DFM_ALERT_MALLOC_FAILED );
	ulDfmAddSymptom( DFM_SYMPTOM_PRODUCT, APP_PRODUCT_IDENTIFIER);
	ulDfmAddSymptom( DFM_SYMPTOM_CURRENT_TASK, (uint32_t) pcTaskGetName(NULL));
	ulDfmAddSymptom( DFM_SYMPTOM_STACKPTR, (uint32_t) __get_PSP());

	// Upload the Alert
	ulDfmSendDataToCloud();

	// Resume tracing
	vTraceClear();
	uiTraceStart();

	/* Ordinary error handling follows, restart? */
}
```
Read on for an explanation of what the code does.

- `vTracePrintF` adds a user event to the trace, in this case the string "Malloc failed". To learn more about user events, search for user event in the Tracealyzer manual.

- `vTraceStop` stops the trace recorder so no new events are recorded while we generate the alert. The trace buffer should not be modified while reading from it.

- `ulDfmAlert` starts a new Alert and sets the alert type. The alert types are defined in dfmCodes.h.

- `ulDfmAddSymptom` adds symptoms to an alert. Symptoms provide additional information about the alert, for example the line and where the error occurred. Multiple symptoms can be added to an alert. Symptoms are defined in dfmCodes.h.

- `ulDfmSendDataToCloud` sends the alert to the cloud. If the error cannot be recovered and the system needs to be restarted before an upload is possible, use `ulDfmSaveDataToNonVolatileMemory` instead. This function saves the data to non volatile memory; the data is then uploaded to the cloud after the system has restarted and reconnected to the cloud.

- `vTraceClear` clears any old trace data.

- `uiTraceStart` starts the trace recorder again.

To see more examples in the demo code, use the built-in `tasks` view in ModusToolbox (Window -> Show view -> Tasks) and look for the tag `FIXME DevAlert example`. 

# Learning more
If you have questions about this demo, DevAlert or Tracealyzer, feel free to contact support@percepio.com.
For licensing information, please contact sales@percepio.com.
